## 4 语法分析

### 4.1 句法分析概述

-   主要任务: 
    -    从***token***序列**中，识别**语法成分/短语**，构造**语法分析树**，指导**翻译过程

-   基本方法: 
    -   自顶向下: 自顶向下构造语法分析树, 根据**输入符**，选择合适的**产生式**推导**最左非终结符**, 直到推导出完整的输入串
        -   递归下降分析法
        -   预测分析法
    -   自底向上: 自底向上构造语法分析树, 根据**输入符,** 选择合适的**句柄**进行归约, 直至将输入符串归约为文法开始符号
        -   算符优先分析法
        -   LR分析法

### 4.2 自顶向下分析概述

*自顶向下分析的基本思想与主要问题：*

-   基本思想
    -    自顶向下构造语法分析树, 根据**输入符**，选择合适的**产生式**推导**最左非终结符**, 直到推导出完整的输入串

    -   最左非终结符也是当前语法分析树的**最左非终结符节点**, 代表**最左推导**
    -   替换后会在语法分析树上**生成子节点**

-   主要问题

    >   本质上是**文法改造问题**，都是基于**上下文无关文法**的改造

    -    二义性问题

         -   问题描述：文法中存在句子有不只一棵**语法分析树**

         -   解决方法：改造文法，引入**细粒度的文法变量**；或人为规定优先级

             >   例如：
             >
             >   -   解决加法和乘法优先级问题：引入**项**和**因子**的文法符号
             >   -   解决`if`匹配问题：引入**“匹配”**和**“不匹配”**的文法符号
             >       -   `if-else`的就近原则
    
    -    回溯问题
    
         -   问题描述：多个**候选式**存在**公共前缀**
         -   解决方法：改造文法；提取左公因子（本质是在推迟决定）
             -   通过**FIRST集**和**FOLLOW集**判断是否会出现回溯
    
    -    左递归问题
    
         -   问题描述：直接左递归、间接左递归
    
         -   解决方法：消除左递归
             -   消除**直接左递归**的一般形式：$A\rarr A\alpha_1|A\alpha_2|...|A\alpha_n|\beta_1|\beta_2|...|\beta_m $
    
                 -   转化为：
                     -   $A\rarr\beta_1A'|\beta_2A'|...|\beta_mA'$
    
                     -   $A'\rarr\alpha_1A'|\alpha_2A'|...|\alpha_nA'|\epsilon$
    
                         >   本质上是将左递归转换成了**右递归**，付出的代价是引入一新的**非终结符**和**空产生式**，注意最后的**空产生式**
    
             -   消除**间接左递归**：先代入到最大编号，再消除直接左递归
                 -   给所有产生式**左部编号**，按编号**从小到大遍历**
                 -   如果出现**左部编号大于右部开头编号**，则出现左递归
                 -   若出现左递归，将相关产生式**代入到左部编号最大的产生式**中，转换成**直接左递归**，然后消除直接左递归

---

*预测分析法的基本思想：*

-   预测分析: 
    -    一般的自顶向下分析往往会因为**产生式选择的不确定性**而需要**回溯**，但**预测分析**就不需要回溯，它依据**预测分析表**，是一种**确定的自顶向下分析方法**

-   文法改造与检查：
    -    并不是所有文法都直接适用于自顶向下的分析，文法转换就是要**改造这些文法**以使其适合**自顶向下的分析**。
         -    消除文法的二义性
         -    消除文法的回溯
         -    消除文法的左递归

    -    改造文法后，还要检查文法是否为LL(1)的

---

*递归下降分析法的基本思想：*

-   根据文法产生式，定义可以递归调用的函数

### 4.3 预测分析法

>   总结
>
>   1.  构造与检查文法
>       1.  构造一般文法
>       2.  改造文法：消除二义性、消除左递归、消除回溯
>       3.  检查是否为LL(1)文法
>
>   1.  设计算法
>       1.  构造**预测分析表**
>       2.  非递归的预测分析：下推自动机

*重要集合的引入与计算：* 

-   FIRST集

    -   定义：文法符号(串)经过**若干步推导**得到的所有符号(串)的**首终结符**的集合

        -   若干步：零步、一步、多步
            >   后面出现的所有“推导”，若无特殊说明，均指的是“经若干步推导”
        -   特例：若能推导出$\epsilon$，则$\epsilon$也加入FIRST集

    -   计算：不断包含右部“开头”符号的FIRST集

        -   终结符的FIRST集**：**只包含该终结符一个元素的集合

        -   **非终结符FIRST集**：**不断包含右部“开头”符号的FIRST集**

            -   右部开头是**终结符**或右部为**空**：直接包含终结符或$\epsilon$
            -   右部开头是**非终结符**：
                -   包含该非终结符的FIRST集（先不包括$\epsilon$）
                -   同时若该非终结符能推导出$\epsilon$，则继续加入右边紧邻符号的FIRST集，直到不能推导出$\epsilon$
                -   若都能推导出$\epsilon$，再将$\epsilon$加入FIRST集中

            >   **文法符号串的FIRST集：**
            >
            >   -   从左向右看，加入**第一个符号的FIRST集**
            >   -   若第一个符号能推导出$\epsilon $，就累加下一个**符号的FIRST集**，直到不能再推出$\epsilon$
            >
            >   -   如果都能推导出$\epsilon $就再加入$\epsilon $

-   FOLLOW集
    -   定义：是**非终结符**相关的一种集合，即**推导**过程中可以**紧跟在该非终结符右侧**的**终结符**的集合
    -   计算：不断包含**右侧的FISRT集**和作为右部结尾时**左部的FOLLOW集**
        -   将**结束标记**加入开始符号的FOLLOW集中
        -   加右边的FIRST集：单看**产生式右部**，跟在某一非终结符**后面的符号串的FIRST集**加入该非终结符的FOLLOW集中，但不能加入$\epsilon$
        -   加左部的FOLLOW集：看**整条产生式**，**右部结尾**的非终结符，以及可能因右方非终结符推导出$\epsilon$而**变成右部结尾**的非终结符，其FOLLOW集要**包含**左部非终结符的FOLLOW集

-   SELECT集
    -   定义：是产生式相关的一种集合，即推导过程中可以选择该产生式时的**输入符号**的集合
    -   计算：产生式的SELECT集的计算
        -   若是空产生式，则为**左部**非终结符的**FOLLOW集**
        -   若非空产生式，则为**右部**符号串的**FIRST集**

---

*适合预测分析的文法：*

>   目标：构造不需要回溯、可用于预测分析的文法（前提是要先适用于自顶向下分析）

-   S_文法
    -   产生式**右部**以**终结符**开始（不包含$\epsilon$产生式）
    -   同一非终结符各个候选式的**首终结符**都不相同

-   q_文法
    -   产生式**右部**或为$\epsilon$，或以**终结符**开始
    -   具有相同左部的产生式有**不相交的可选集**
        -   可选集：可以使用该产生式推导时的**输入符号**集合，称为这个产生式的可选集

-   LL(1)文法：同一非终结符各个**产生式**的**SELECT集**互不相交
    >   下面这三条限制就是为了保证“同一非终结符各个产生式的**SELECT集**互不相交”，是**所有非终结符**都要满足的

    -   若非终结符不能推导出$\epsilon$
        -   各个**候选式**的**FIRST集**不相交
    -   若非终结符能推导出$\epsilon$
        -   各个**候选式**至多有一个能**推导出**$\epsilon$
        -   且该非终结符的**FOLLOW集**和其他候选式的**FIRST集**互不相交

---

*预测分析法的工作：*

-   预测分析的格局/表驱动的下推自动机
    -   控制程序：包含通用的控制**算法**
        >   例如接下来要讲的表驱动的预测分析算法
    -   栈：分析栈，指导**语法分析树**的形成。初始时栈底符号为#，栈顶符号为文法开始符号
        >   预测分析中，栈中的内容就是**句型**
    -   输入：**输入**缓冲区，#为输入串结束符
    -   表：**预测分析表M**
        -   内容：行是**非终结符**，列是**输入符号和#**，表项是以行非终结符为左部的产生式
            >   列输入符号要包含于表项产生式的SELECT集
        -   使用：栈顶非终结符作为行，当前输入作为列，找到表项中的产生式进行推导

-   **表驱动的预测分析法/**非递归的预测分析法：
    -    借助**下推自动机和预测分析表**

    -   对比输入符号与栈顶符号，直到**栈顶和输入**都为结束符
    -   若栈顶符号为**终结符**
        -   二者**相等**，则弹栈，消耗输入符号，读头后移
        -   二者不相等，则报错
    -   若栈顶符号为**非终结符**：查询预测分析表得到**产生式**，左部弹栈，右部入栈（**自右向左**入栈）不消耗**输入符号**

---

*预测分析法的错误处理：*

-   错误检测
    -   最左/栈顶**终结符**与当前**输入符号不匹配**
    -   最左/栈顶**非终结符**与当前输入符号在**预测分析表**中**无可用产生式**

-   错误恢复：恐慌模式
    -   最左/栈顶**终结符**与当前输入不匹配时：直接忽略输入符号（删除）
    -   最左/栈顶**非终结符**与当前输入符号在**预测分析表**中无可用产生式：
        -   若输入符号不在该非终结符的**FOLLOW集**中，则忽略输入符号（删除）
        -   若输入符号在该非终结符的**FOLLOW集**中（同步词法单元），则忽略/弹出该非终结符
        
            >   FOLLOW集本质就是非终结符**推出空**时的SELECT集

### 4.4 递归下降分析法

-   文法：要求文法是LL(1)的

-   分析：从文法**开始符号的产生式**开始，遍历右部符号（即**调用文法开始符号的过程**）

    >   遍历符号的过程中，每次取得一个输入，终结符消耗输入，非终结符根据输入选择产生式

    -   若为终结符，则必须等于当前输入符号，否则报错

    -   若为非终结符，则“递归”调用**该非终结符对应的过程**

        >   非终结符对应的过程：
        >
        >   -   若有**多条产生式**，先根据输入和SELECT集选择产生式
        >   -   遍历产生式右部符号，若是终结符，则当前输入必须与之相等，否则报错；若是非终结符，则调用其过程

    -   最后一个输入符号必须是终结符

